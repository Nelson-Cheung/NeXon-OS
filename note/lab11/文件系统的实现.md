块是文件系统读写的基本单位，块的大小是扇区大小的整数倍。

文件组织形式参照UNIX文件系统中的索引结构`inode`（index node）。每个文件都有一个`inode`。

inode的结构包括inode编号、权限、属主、时间、文件大小和索引表等。

文件系统为每个文件的所有块建立了一个索引表，索引表实际上是块数组地址，每个数组元素的块的地址，数组下标是块的编号。

每个索引表中共15个索引项，0\~11个是直接索引块，12是一级间接索引块，13是二级间接索引块，14是三级间接索引块。

只要用于管理、空值文件相关信息的数据结构都被称为FCB，inode只是其中一种。

Linux中每分区的inode数量是固定的，即文件数量是固定的。

为了方便管理，分区中所有文件的inode通过一个inode数组来维护，称为inode\_table

inode是文件系统需要的东西，但用户是通过文件名来访问文件的，因此需要通过“目录”来将二者联系起来。

在Linux中，文件和目录都用inode来表示，区分二者的方式是通过数据块保存的内容。如果inode表示的是目录文件，此inode指向的数据块中的内容应该是该目录下的目录项。如果inode表示的是普通文件，数据块中保存的内容应该是普通文件自己的数据。

目录项相当于表格中的一个条目，其中包含文件名、文件类型和inode编号，是文件的一个简要描述。

有了目录项之后，通过文件名找到文件实体数据块的流程是

+ 在目录中找到文件名所在的目录项。
+ 从目录项中获取inode编号。
+ 用inode编号作为inode数组的索引下标找到inode。
+ 从该inode中获取数据块的地址，读取数据块。

文件系统中存在一个根目录，查找任意文件时，都直接到根目录的数据块中找到相关的目录项，然后递归查找。

超级块是维护inode信息的结构，在创建文件系统时被创建的，有关文件系统的所有配置信息都被保存在超级块中。因此，超级块的大小必须要固定下来。超级块包含魔数、inode数量、分区起始扇区地址、空闲块位图地址、空闲块大小、inode位图地址、inode位图大小、inode数组地址、inode数据大小、根目录地址、根目录大小和空闲块起始地址等。



格式化分区

创建文件系统就是创建文件系统所需要的元信息，包括超级块位置及大小、空闲块位图的位置及大小、inode位图的位置及大小、inode\_table数组位置及大小、空闲块的起始地址、根目录的起始地址。步骤如下。

+ 根据分区part的大小，计算分区文件系统各个元信息所需要的扇区数及位置。
+ 在内存中创建超级块，将以上步骤计算的元信息写入超级块。
+ 将超级块写入磁盘。
+ 将元信息写入磁盘上各自的位置。
+ 将根目录写入磁盘。

# 文件描述符

文件描述符的逻辑结构：文件偏移量，文件打开标志，inode指针

Linux把所有的文件描述符组织到一起形成数组统一管理，这个数组称为文件表

在Linux中每个进程都有单独的、完全相同的一套文件描述符，因此它们与其他进程的文件描述符互不干涉，这些文件描述符被组织成文件描述符数组统一管理。同时，进程可打开的最大文件数有限。

文件描述符数组中只保存**存储文件表**中的文件结构下标。

文件描述符是文件结构的索引。

Linux通过文件描述符查找文件数据的过程涉及以下三个数据结构（3个数据结构都是存储在内存中的）

+ PCB中的文件描述符数组
+ 存储所有文件结构的文件表
+ inode队列（缓存）

某进程把文件描述符作为参数提交给文件系统时，文件系统用此文件描述符在该进程的 PCB 中的文件描述符数组中索引对应的元素，从该元素中获取对应的文件结构的下标，用该下标在文件表中索引相应的文件结构，从该文件结构中获取文件的 inode，最终找到了文件的数据块。提示一下，若该 inode 在 inode 队列中不存在，此时会多一个处理过程：文件系统会从硬盘上将该 inode 加载到 inode 队列中，并使文件结构中的 fd_inode 指向它，将来介绍 inode 操作相关的函数时会再次提到  

创建文件描述符的过程就是逐层在这三个数据结构中找空位，在空位填充好数据后返回该位置的地址。

1. 在全局的inode队列中新建一个inode，然后返回inode地址。
2. 在全局的文件表中找一空位，在该位置填充文件结构，是fd_inode指向上一步返回的inode地址，然后返回本文件结构在文件表中的下标值。
3. 在PCB的文件描述符数组中找一空位，是该位置的值指向上一步中返回的文件结构下标，并返回本文件描述符在文件描述符数组的下标值。

# 文件操作相关的基础函数

## inode操作有关的函数

```cpp
inode_locate //根据inode的编号得到inode所在的扇区和扇区内的偏移量
    
```



## 文件相关的函数

## 目录相关的函数

## 路径解析相关的函数

## 实现文件检索功能