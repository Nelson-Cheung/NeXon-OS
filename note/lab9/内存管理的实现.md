### 内存分配

`arena`, `mem_block_desc`

mem_block_desc记录内存块的规格大小以及位于所有同类arena中的空闲内存块链表。

本质上是将内存以更细粒度划分，划分为16，32，64，128，256，512和1024。每次分配一个页作为`arena`，其以粒度为单位将内存划分为若干块，并放入空闲队列中。当需要分配内存时，上取整最小的arena，从中空闲列表中找一块来分配。特别地，当分配大小大于1024时，直接分配连续的若干页。

每个进程应该分别进行内存管理

### 内存释放

释放内存是和分配内存相反的过程。

1. 在物理地址池中释放物理页地址。将物理地址对应的位图对应的位清0即可。
2. 在页表中去掉虚拟地址的映射，即将pte的P位置0，同时更新TLB。invlpg  使TLB中虚拟地址失效（在程序段CPL=0下执行）。invlpg [addr]
3. 在虚拟地址池中释放虚拟地址。清零最后的虚拟地址对应的位图的位。

内存的回收和释放

+ 回收。将小块内存放置到空闲块队列上。
+ 释放。释放分配的页框。



### malloc & free

增加系统调用即可。



### 问题

+ 进入内核态是否会更改cr3？不会，线程/进程切换才会更改cr3